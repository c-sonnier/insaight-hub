<%
  page_title @insight_item.title
  page_description @insight_item.description.presence || "#{@insight_item.title} - An insight by #{@insight_item.user.name} on insAIght Hub"
  page_type "article"
  page_url insight_item_url(@insight_item)
  page_keywords @insight_item.tags.any? ? @insight_item.tags.join(", ") : nil
%>

<div class="flex flex-col h-[100dvh]">
  <%= render "insight_items/show_toolbar", insight_item: @insight_item %>

  <div class="flex flex-1 overflow-hidden relative" data-controller="sidebar-toggle">
    <% unless @insight_item.single_file? %>
      <%# Collapsible sidebar with toggle button %>
      <div class="flex-none flex" data-sidebar-toggle-target="sidebarWrapper">
        <div class="w-64 bg-base-200 border-r border-base-300 overflow-y-auto p-4" data-sidebar-toggle-target="sidebar">
          <h3 class="font-semibold mb-3">Files</h3>
          <ul class="menu menu-sm bg-base-100 rounded-lg">
            <% @insight_item_files.each do |file| %>
              <li>
                <%= link_to file.filename, insight_item_path(@insight_item, file: file.filename),
                    class: "#{file == @current_file ? 'active' : ''}" %>
              </li>
            <% end %>
          </ul>

          <% if @insight_item.description.present? %>
            <div class="mt-6">
              <h3 class="font-semibold mb-2">Description</h3>
              <p class="text-sm text-base-content/70"><%= @insight_item.description %></p>
            </div>
          <% end %>

          <% if @insight_item.tags.any? %>
            <div class="mt-4">
              <h3 class="font-semibold mb-2">Tags</h3>
              <div class="flex flex-wrap gap-1">
                <% @insight_item.tags.each do |tag| %>
                  <%= link_to tag, insight_items_path(tag: tag), class: "badge badge-ghost badge-sm hover:badge-primary" %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <%# Toggle button attached to sidebar edge %>
        <button
          type="button"
          class="self-center -ml-px bg-base-200 hover:bg-base-300 border border-base-300 border-l-0 rounded-r-lg p-1 transition-all"
          data-action="sidebar-toggle#toggle"
          title="Toggle sidebar"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-sidebar-toggle-target="toggleIcon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
      </div>
    <% end %>

    <div class="flex-1 bg-white relative" data-controller="insight-view fullscreen" data-fullscreen-target="container">
      <% if @current_file %>
        <button type="button" class="absolute top-2 right-2 z-10 btn btn-ghost btn-sm btn-circle bg-base-100/80 hover:bg-base-100" data-action="fullscreen#toggle" title="Toggle fullscreen">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
          </svg>
        </button>
        <iframe
          src="<%= insight_item_file_path(@insight_item, @current_file.filename) %>"
          class="w-full h-full border-0"
          data-insight-view-target="iframe"
        ></iframe>
      <% else %>
        <div class="flex items-center justify-center h-full text-base-content/60">
          <p>No files in this insight.</p>
        </div>
      <% end %>
    </div>

    <%# Comments drawer (collapsible right panel) %>
    <div id="comments-drawer"
         class="hidden flex-none w-96 bg-base-100 border-l border-base-300 overflow-y-auto"
         data-comments-drawer-target="drawer">
      <div class="p-4">
        <%= render "comments/list", insight_item: @insight_item, comments: @comments %>
      </div>
    </div>
  </div>
</div>

<%# Share Modal %>
<% if authenticated? && (@insight_item.user == Current.user || Current.user&.admin?) %>
  <dialog id="share_modal" class="modal">
    <div class="modal-box">
      <%= render "insight_items/share_panel", insight_item: @insight_item %>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn">Close</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>
